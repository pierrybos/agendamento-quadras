generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "debian-openssl-1.1.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id            String        @id @default(cuid())
  email         String        @unique
  name          String?
  birthDate     DateTime? // Data de aniversário
  phone         String? // Número de telefone
  companyId     Int?        // Null se for admin
  company       Empresa?     @relation("EmpresaToUser", fields: [companyId], references: [id]) // Apenas o User nomeia a relação
  isWhatsApp    Boolean? // Indica se o telefone é WhatsApp
  mensalista    Boolean? // false normal true mensalista
  type          String @default("cliente") // Tipo de cliente: "mensalista" ou "normal"
  role          String @default("user") // Define o papel: "admin" ou "user"
  emailVerified DateTime?     // Campo necessário para NextAuth
  image         String?       // Campo necessário para NextAuth
  agendamentos  Agendamento[]
  accounts      Account[] // Relação de volta para Account
  sessions      Session[]
  empresaOwned  Empresa?     @relation("UserToEmpresa")
  createdAt     DateTime     @default(now())
  updatedAt     DateTime     @updatedAt

  @@map("users")
}

model Empresa {
  id          Int         @id @default(autoincrement())
  name        String
  address     String
  contact     String
  ownerId     String       @unique // Um gerente para uma empresa
  owner       User        @relation("UserToEmpresa", fields: [ownerId], references: [id]) // Apenas a Empresa define a relação
  quadras     Quadra[]
  precos      Price[]
  horarios    Horario[]
  agendamentos Agendamento[]
  users       User[]       @relation("EmpresaToUser")
  createdAt   DateTime    @default(now())
  isActive    Boolean     @default(true) // Exclusão lógica
}

model Quadra {
  id           Int           @id @default(autoincrement())
  name         String // Nome da quadra
  location     String // Localização ou endereço
  description  String? // Descrição adicional
  empresaId    Int
  empresa      Empresa     @relation(fields: [empresaId], references: [id])
  available    Boolean       @default(true)
  isActive     Boolean       @default(true) // Exclusão lógica
  createdAt    DateTime      @default(now())
  prices       QuadraPrice[] // Relação N-N com Price
  horarios     Horario[] // Relação com horários
  agendamentos Agendamento[]
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?
  user              User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@map("accounts")
}

model Price {
  id       Int           @id @default(autoincrement())
  type     String // Tipo: "mensalista" ou "normal"
  duration Int // Duração em horas (ex.: 1h, 2h)
  value    Float // Valor do preço
  empresaId Int
  empresa  Empresa     @relation(fields: [empresaId], references: [id])
  isActive Boolean      @default(true) // Exclusão lógica
  createdAt DateTime    @default(now())
  quadras  QuadraPrice[] // Relação N-N com Quadra
}

model QuadraPrice {
  id       Int    @id @default(autoincrement())
  quadraId Int
  priceId  Int
  quadra   Quadra @relation(fields: [quadraId], references: [id])
  price    Price  @relation(fields: [priceId], references: [id])
}

model Horario {
  id           Int           @id @default(autoincrement())
  start        DateTime // Hora de início
  end          DateTime // Hora de término
  quadraId     Int
  quadra       Quadra   @relation(fields: [quadraId], references: [id])
  empresaId    Int      // Voltando a ser obrigatório
  empresa      Empresa  @relation(fields: [empresaId], references: [id])
  isActive     Boolean  @default(true) // Exclusão lógica
  createdAt    DateTime @default(now())
  agendamentos Agendamento[]
}

model Agendamento {
  id               Int      @id @default(autoincrement())
  userId           String
  quadraId         Int
  horarioId        Int
  empresaId        Int
  status           String   @default("pending") // Status: pending, confirmed, cancelled
  totalValue       Float // Valor total calculado
  paymentStatus    String   @default("pending") // Status do pagamento: pending, paid, failed
  paymentMethod    String   @default("pix") // Método de pagamento (default: Pix)
  paymentReference String? // Referência do pagamento no provedor
  isActive         Boolean  @default(true) // Exclusão lógica
  createdAt        DateTime @default(now())
  user             User     @relation(fields: [userId], references: [id])
  quadra           Quadra   @relation(fields: [quadraId], references: [id])
  horario          Horario  @relation(fields: [horarioId], references: [id])
  empresa          Empresa  @relation(fields: [empresaId], references: [id])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}
